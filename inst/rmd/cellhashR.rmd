---
title: "`r params$doc_title`"
date: "`r Sys.Date()`"
params:
  doc_title: "Example cellhashR Report"
output:
  rmdformats::html_clean:
    highlight: kate
    self_contained: yes
    thumbnails: yes
    fig_width: 12
    code_folding: hide

---

```{r setup}

library(cellhashR)

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=TRUE, error=TRUE)

knitr::opts_knit$set(root.dir = '/Projects/cellhashR')

```

```{r setupVariables, include=FALSE}

requiredVars <- c('rawCountData', 'callFile')
for (v in requiredVars) {
	if (!exists(v)) {
		stop(paste0('Need to define variable: ', v))
	}
}

if (!file.exists(rawCountData)) {
  stop(paste0('Could not find rawCountData: ', rawCountData))
}

optionalVars <- c('barcodeWhitelist', 'cellbarcodeWhitelist', 'citeSeqCountDir', 'minCountPerCell')
for (v in requiredVars) {
	if (!exists(v)) {
		if (v == 'minCountPerCell') {
			minCountPerCell <- 5
		} else {
			assign(v, NULL)
		}
	}
}


```

# Data Loading / QC

```{r QC, fig.width=12}

if (!is.null(citeSeqCountDir)) {
  saturation <- cellhashR:::PlotLibrarySaturation(citeSeqCountDir)
}

saveOriginalCellBarcodeFile <- 'originalBarcodes.txt'
barcodeData <- ProcessCountMatrix(rawCountData = rawCountData, minCountPerCell = minCountPerCell, barcodeWhitelist = barcodeWhitelist, saveOriginalCellBarcodeFile = saveOriginalCellBarcodeFile)
if (nrow(barcodeData) == 0) {
  stop('No passing barcodes')
}

if (ncol(barcodeData) == 0) {
  stop('No passing cells')
}

```

# Normalization / QC

These plots are designed to provide visualization of potential normalizations.

```{r NormalizationQC, fig.width=12}

PlotNormalizationQC(barcodeData)

```

# Generate Hashing Calls

```{r GenerateCalls, fig.width=12}

if (nrow(barcodeData) > 0 && ncol(barcodeData) > 0){
	
	cellbarcodeWhitelist <- read.table(saveOriginalCellBarcodeFile, header = FALSE, col.names = c('cellbarcode'))
	df <- GenerateCellHashingCalls(barcodeMatrix = barcodeData, methods = methods, cellbarcodeWhitelist = cellbarcodeWhitelist$cellbarcode)
	write.table(df, file = callFile, sep = '\t', row.names = FALSE, quote = FALSE)
} else {
	stop('No passing cels were found in the count matrix')
}

```

# Final Calls

```{r}

knitr::kable(head(df, n = 10))

```

# Print Session Info

```{r SessionInfo}

sessionInfo()

```

