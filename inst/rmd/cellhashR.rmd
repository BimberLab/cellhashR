---
title: 'Cell Hashing Example'
output: html_document

---

```{r setup}

library(cellhashR)

knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=TRUE, error=TRUE)

knitr::opts_knit$set(root.dir = '/Projects/cellhashR')

```

```{r libraryQC}

cellhashR:::PlotLibrarySaturation('./tests/testdata/438-21-GEX')


```


## Basic QC and Filtering on input:

```{r QC, fig.width=12}

barcodeDir <- './tests/testdata/cellHashing/247-1-hashTagCounts.txt'

barcodeData <- ProcessCountMatrix(rawCountData = barcodeDir, minCountPerCell = 5)
if (nrow(barcodeData) == 0) {
  print('No passing barcodes')
}

if (ncol(barcodeData) == 0) {
  print('No passing cells')
}

```

```{r QC, fig.width=12}

barcodeDir <- '/Projects/cellhashR/tests/testdata/cellHashing/247-1-hashTagCounts.txt'

barcodeData <- ProcessCountMatrix(rawCountData = barcodeDir, minCountPerCell = 5, barcodeWhitelist = c('HTO-1', 'HTO-2', 'HTO-3', 'HTO-4', 'HTO-6'))
if (nrow(barcodeData) == 0) {
  print('No passing barcodes')
}

if (ncol(barcodeData) == 0) {
  print('No passing cells')
}

```

```{r}


NormalizationQC(barcodeData)



```


## Generate calls

```{r GenerateCalls, fig.width=12}

if (nrow(barcodeData) > 0 && ncol(barcodeData) > 0){
    dt <- GenerateCellHashingCalls(barcodeData = barcodeData, outFile = finalCallFile, allCallsOutFile = allCallsOutFile, useSeurat = useSeurat, useMultiSeq = useMultiSeq)

    if (exists('whitelistFile') && !is.null(whitelistFile)){
      GenerateSummaryForExpectedBarcodes(dt, whitelistFile=whitelistFile, outputFile=metricsFile, barcodeData=barcodeData)
    }
}

```

## Print Session Info

```{r SessionInfo}

sessionInfo()

```

