<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Demultiplexing with Bimodal Flexible Fitting (BFF) • cellhashR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Demultiplexing with Bimodal Flexible Fitting (BFF)">
<meta property="og:description" content="cellhashR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cellhashR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/V01-QC-example.html">Data/Normalization QC</a>
    </li>
    <li>
      <a href="../articles/V02-BFF-example.html">Demultiplexing with Bimodal Flexible Fitting (BFF)</a>
    </li>
    <li>
      <a href="../articles/V03-Benchmark-example.html">Benchmarking Demultiplexing Algorithms with cellhashR</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BimberLab/cellhashR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="V02-BFF-example_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Demultiplexing with Bimodal Flexible Fitting (BFF)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BimberLab/cellhashR/blob/master/vignettes/V02-BFF-example.Rmd"><code>vignettes/V02-BFF-example.Rmd</code></a></small>
      <div class="hidden name"><code>V02-BFF-example.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette demonstrates how to use cellhashR’s Bimodal Flexible Fitting (BFF) Demultiplexing Algorithm to produce the kinds of analyses reported in the BFF paper. cellhashR produces many plots and outputs that provide useful information about cell hashing data. For purposes of brevity and clarity, only output related to figures in the BFF paper is shown in this report. The data analyzed in this vignette is the same data analyzed in the BFF paper.</p>
<style type="text/css">
img {
    margin: 5px 10px 5px 10px;
    max-width:100%;
    height: auto;
}
</style>
</div>
<div id="load-data" class="section level1">
<h1 class="hasAnchor">
<a href="#load-data" class="anchor"></a>Load Data</h1>
<p>cellhashR expects count data with cells in columns and barcode features in rows.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BimberLab/cellhashR">cellhashR</a></span><span class="op">)</span>
<span class="va">rawCountData</span> <span class="op">&lt;-</span> <span class="st">"../tests/testdata/MS/cell_type_counts.csv"</span>
<span class="va">barcodeData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="va">rawCountData</span>, header <span class="op">=</span> <span class="cn">TRUE</span>, row.names <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="normalization-qc" class="section level1">
<h1 class="hasAnchor">
<a href="#normalization-qc" class="anchor"></a>Normalization / QC</h1>
<p>The plots appearing in the following figure from the BFF paper are generated using the cellhashR command PlotNormalizationQC.</p>
<p><img src="BFF-example_files/figure-html/QC_fig.png" width="525"></p>
<p>The following code produces QC plots helpful in visualizing the effects of various normalization procedures on cell hashing data, including the novel normalization Bimodal Quantile Normalization (BQN).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/PlotNormalizationQC.html">PlotNormalizationQC</a></span><span class="op">(</span><span class="va">barcodeData</span>, methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Raw'</span>, <span class="st">'bimodalQuantile'</span>, <span class="st">'log2Center'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="BFF-example_files/figure-html/NormalizationQC-1.png" width="576"><img src="BFF-example_files/figure-html/NormalizationQC-2.png" width="576"><img src="BFF-example_files/figure-html/NormalizationQC-3.png" width="576"><img src="BFF-example_files/figure-html/NormalizationQC-4.png" width="576"></p>
<pre><code>## [1] "Printing Raw Count QC Plots"</code></pre>
<p><img src="BFF-example_files/figure-html/NormalizationQC-5.png" width="576"><img src="BFF-example_files/figure-html/NormalizationQC-8.png" width="576"></p>
<pre><code>## [1] "Printing bimodalQuantile Normalization QC Plots"</code></pre>
<p><img src="BFF-example_files/figure-html/NormalizationQC-9.png" width="576"><img src="BFF-example_files/figure-html/NormalizationQC-12.png" width="576"></p>
<pre><code>## [1] "Printing log2Center Normalization QC Plots"</code></pre>
<p><img src="BFF-example_files/figure-html/NormalizationQC-13.png" width="576"><img src="BFF-example_files/figure-html/NormalizationQC-16.png" width="576"></p>
</div>
<div id="generate-hashing-calls" class="section level1">
<h1 class="hasAnchor">
<a href="#generate-hashing-calls" class="anchor"></a>Generate Hashing Calls</h1>
<p>The cellhashR command GenerateCellHashingCalls performs demultiplexing analysis on the data using the algorithms listed in “methods” (BFF_raw and BFF_cluster in the current analysis). Below are results from four calls to GenerateCellHashingCalls, each time using a different parameter set for BFF_cluster.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bff_raw"</span>, <span class="st">"bff_cluster"</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GenerateCellHashingCalls.html">GenerateCellHashingCalls</a></span><span class="op">(</span>barcodeMatrix <span class="op">=</span> <span class="va">barcodeData</span>, methods <span class="op">=</span> <span class="va">methods</span>, cellbarcodeWhitelist <span class="op">=</span> <span class="va">cellbarcodeWhitelist</span>, metricsFile <span class="op">=</span> <span class="va">metricsFile</span>, bff_cluster.doublet_thresh<span class="op">=</span><span class="fl">0.05</span>, bff_cluster.neg_thresh<span class="op">=</span><span class="fl">0.05</span>, bff_cluster.dist_frac<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span><span class="op">(</span><span class="va">df</span>, file <span class="op">=</span> <span class="va">callFile</span>, sep <span class="op">=</span> <span class="st">'\t'</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>, quote <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div id="bff_raw" class="section level3">
<h3 class="hasAnchor">
<a href="#bff_raw" class="anchor"></a>BFF_raw</h3>
<pre><code>## [1] "Starting BFF_raw"
## [1] "rows dropped for low counts: 0 of 12"</code></pre>
<p>The lines of output above are printed when BFF_raw is run (as opposed to BFF_cluster).</p>
<p><img src="BFF-example_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>The figure above will be generated each time BFF is run on this data (in either the threshold mode or the cluster mode). Similarly, the list of thresholds below (not in log-space) is given each time BFF is run on the data. Both outputs are shown in this document only this once, for sake of brevity.</p>
<p>BFF_raw classifies droplets based on comparison of raw count values to the thresholds found by fitting. Droplets are classified as singlets when they are positive for just one barcode, as doublets when positive for multiple barcodes, and as negatives when they are negative for all barcodes.</p>
<pre><code>## [1] "Thresholds:"
## [1] "Bar12: 137.252466391685"
## [1] "Bar11: 101.320341426663"
## [1] "Bar10: 102.166166632405"
## [1] "Bar9: 119.819102035079"
## [1] "Bar8: 121.225210166733"
## [1] "Bar7: 125.094886095467"
## [1] "Bar6: 65.6394846865428"
## [1] "Bar5: 101.483503173679"
## [1] "Bar4: 729.16925156116"
## [1] "Bar3: 75.1400201328909"
## [1] "Bar2: 1116.2498732095"
## [1] "Bar1: 216.243218824503"</code></pre>
</div>
<div id="bff_cluster" class="section level3">
<h3 class="hasAnchor">
<a href="#bff_cluster" class="anchor"></a>BFF_cluster</h3>
<p>The figure below demonstrates the theory on which BFF_cluster operates. BFF_cluster classification is tunable with three parameters that affect thresholds in the 2D space of top 2 normalized counts. Parameter values are specified for the three parameters <strong>bff_cluster.doublet_thresh</strong> (shown as beta_c in the figure), <strong>bff_cluster.neg_thresh</strong> (shown as alpha_c in the figure), and <strong>bff_cluster.dist_frac</strong> (shown as delta_c in the figure) as demonstrated in the call to GenerateCellHashingCalls above.</p>
<p><img src="BFF-example_files/figure-html/sim_curves.png" width="525"></p>
<div id="bff_cluster-0-05-0-05-0-1" class="section level4">
<h4 class="hasAnchor">
<a href="#bff_cluster-0-05-0-05-0-1" class="anchor"></a>BFF_cluster (0.05, 0.05, 0.1)</h4>
<p>The first set of graphs below demonstrates output for default values for parameters bff_cluster.doublet_thresh, bff_cluster.neg_thresh, and bff_cluster.dist_frac of 0.05, 0.05, and 0.1, respectively.</p>
<pre><code>## [1] "Starting BFF_cluster"
## [1] "rows dropped for low counts: 0 of 12"
## [1] "Doublet thresh:  0.05"
## [1] "Neg thresh:  0.05"
## [1] "Min distance as fraction of distance between peaks:  0.1"</code></pre>
<p><img src="BFF-example_files/figure-html/unnamed-chunk-2-18.png" width="576"></p>
<p>The lines of output above are printed when BFF_cluster is run. The parameter values output here are the default values for BFF_cluster.</p>
<p>The figure above is generated each time BFF_cluster is run (BQN threshold values are not affected by parameter values) but is shown only once here for brevity. In this figure, BQN data and BQN thresholds are shown.</p>
<p>The figure on the left below shows how BFF_cluster droplet classifications cluster in the 2D space of top 2 normalized counts for parameter values for bff_cluster.doublet_thresh, bff_cluster.neg_thresh, and bff_cluster.dist_frac of 0.05, 0.05, and 0.1, respectively. The figure on the right compares the BFF_cluster classifications with BFF_raw classifications (consensus output can be ignored).</p>
<p><img src="BFF-example_files/figure-html/unnamed-chunk-2-19.png" width="576"><img src="BFF-example_files/figure-html/unnamed-chunk-2-35.png" width="576"></p>
</div>
<div id="bff_cluster-0-2-0-05-0-1" class="section level4">
<h4 class="hasAnchor">
<a href="#bff_cluster-0-2-0-05-0-1" class="anchor"></a>BFF_cluster (0.2, 0.05, 0.1)</h4>
<p>The figure on the left below shows how BFF_cluster droplet classifications cluster in the 2D space of top 2 normalized counts for parameter values for bff_cluster.doublet_thresh, bff_cluster.neg_thresh, and bff_cluster.dist_frac of 0.2, 0.05, and 0.1, respectively. The figure on the right compares the BFF_cluster classifications with BFF_raw classifications (consensus output can be ignored).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GenerateCellHashingCalls.html">GenerateCellHashingCalls</a></span><span class="op">(</span>barcodeMatrix <span class="op">=</span> <span class="va">barcodeData</span>, methods <span class="op">=</span> <span class="va">methods</span>, cellbarcodeWhitelist <span class="op">=</span> <span class="va">cellbarcodeWhitelist</span>, metricsFile <span class="op">=</span> <span class="va">metricsFile</span>, bff_cluster.doublet_thresh<span class="op">=</span><span class="fl">0.2</span>, bff_cluster.neg_thresh<span class="op">=</span><span class="fl">0.05</span>, bff_cluster.dist_frac<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span><span class="op">(</span><span class="va">df</span>, file <span class="op">=</span> <span class="va">callFile</span>, sep <span class="op">=</span> <span class="st">'\t'</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>, quote <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Starting BFF_cluster"
## [1] "rows dropped for low counts: 0 of 12"
## [1] "Doublet thresh:  0.2"
## [1] "Neg thresh:  0.05"
## [1] "Min distance as fraction of distance between peaks:  0.1"</code></pre>
<p><img src="BFF-example_files/figure-html/unnamed-chunk-3-19.png" width="576"><img src="BFF-example_files/figure-html/unnamed-chunk-3-35.png" width="576"></p>
</div>
<div id="bff_cluster-0-05-0-2-0-1" class="section level4">
<h4 class="hasAnchor">
<a href="#bff_cluster-0-05-0-2-0-1" class="anchor"></a>BFF_cluster (0.05, 0.2, 0.1)</h4>
<p>The figure on the left below shows how BFF_cluster droplet classifications cluster in the 2D space of top 2 normalized counts for parameter values for bff_cluster.doublet_thresh, bff_cluster.neg_thresh, and bff_cluster.dist_frac of 0.05, 0.2, and 0.1, respectively. The figure on the right compares the BFF_cluster classifications with BFF_raw classifications (consensus output can be ignored).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GenerateCellHashingCalls.html">GenerateCellHashingCalls</a></span><span class="op">(</span>barcodeMatrix <span class="op">=</span> <span class="va">barcodeData</span>, methods <span class="op">=</span> <span class="va">methods</span>, cellbarcodeWhitelist <span class="op">=</span> <span class="va">cellbarcodeWhitelist</span>, metricsFile <span class="op">=</span> <span class="va">metricsFile</span>, bff_cluster.doublet_thresh<span class="op">=</span><span class="fl">0.05</span>, bff_cluster.neg_thresh<span class="op">=</span><span class="fl">0.2</span>, bff_cluster.dist_frac<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span><span class="op">(</span><span class="va">df</span>, file <span class="op">=</span> <span class="va">callFile</span>, sep <span class="op">=</span> <span class="st">'\t'</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>, quote <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Starting BFF_cluster"
## [1] "rows dropped for low counts: 0 of 12"
## [1] "Doublet thresh:  0.05"
## [1] "Neg thresh:  0.2"
## [1] "Min distance as fraction of distance between peaks:  0.1"</code></pre>
<p><img src="BFF-example_files/figure-html/unnamed-chunk-4-19.png" width="576"><img src="BFF-example_files/figure-html/unnamed-chunk-4-35.png" width="576"></p>
</div>
<div id="bff_cluster-0-05-0-05-0-25" class="section level4">
<h4 class="hasAnchor">
<a href="#bff_cluster-0-05-0-05-0-25" class="anchor"></a>BFF_cluster (0.05, 0.05, 0.25)</h4>
<p>The figure on the left below shows how BFF_cluster droplet classifications cluster in the 2D space of top 2 normalized counts for parameter values for bff_cluster.doublet_thresh, bff_cluster.neg_thresh, and bff_cluster.dist_frac of 0.05, 0.05, and 0.25, respectively. The figure on the right compares the BFF_cluster classifications with BFF_raw classifications (consensus output can be ignored).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GenerateCellHashingCalls.html">GenerateCellHashingCalls</a></span><span class="op">(</span>barcodeMatrix <span class="op">=</span> <span class="va">barcodeData</span>, methods <span class="op">=</span> <span class="va">methods</span>, cellbarcodeWhitelist <span class="op">=</span> <span class="va">cellbarcodeWhitelist</span>, metricsFile <span class="op">=</span> <span class="va">metricsFile</span>, bff_cluster.doublet_thresh<span class="op">=</span><span class="fl">0.05</span>, bff_cluster.neg_thresh<span class="op">=</span><span class="fl">0.05</span>, bff_cluster.dist_frac<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span><span class="op">(</span><span class="va">df</span>, file <span class="op">=</span> <span class="va">callFile</span>, sep <span class="op">=</span> <span class="st">'\t'</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>, quote <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Starting BFF_cluster"
## [1] "rows dropped for low counts: 0 of 12"
## [1] "Doublet thresh:  0.05"
## [1] "Neg thresh:  0.05"
## [1] "Min distance as fraction of distance between peaks:  0.25"</code></pre>
<p><img src="BFF-example_files/figure-html/unnamed-chunk-5-19.png" width="576"><img src="BFF-example_files/figure-html/unnamed-chunk-5-35.png" width="576"></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
